<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Hardly Print Editor</title>
    <!-- <link rel="stylesheet" href="./css/workflow.css"> -->
    <link rel="stylesheet" href="./css/monaco.css">
    <link rel="stylesheet" href="./css/xterm.css">
    <link rel="stylesheet" href="./css/main.css">
    <link rel="stylesheet" href="./css/litegraph.css">
    <link rel="stylesheet" href="./css/ui.css">
    <link rel="stylesheet" href="./css/titlebar.css">
    <link rel="stylesheet" href="./css/all.min.css">
    <script src="./js/lib/xterm.js"></script>
    <script src="./js/lib/addon-fit.js"></script>
    <script src="./js/lib/addon-attach.js"></script>
    <script src="./js/lib/litegraph.core.min.js"></script>
    <script src="./js/vs/loader.js"></script>
</head>

<body style="background-color: transparent">
    <div class="titlebar" data-tauri-drag-region>
        <div class="controls">
            <button id="titlebar-minimize">-</button>
            <button id="titlebar-maximize">f</button>
            <button id="titlebar-close">x</button>
        </div>
    </div>
    <div class="container">
        <div class="canvas-container">
            <canvas id="workflowCanvas"></canvas>
        </div>
    </div>
    
    <div id="editor-container">
        <nav id="main-editor-navs" class="navs">
            <button onclick="switchSection('files')" class="nav-button" id="files-btn" title="Files">../</button>
            <button onclick="switchSection('terminal')" class="nav-button" id="terminal-btn" title="Terminal">>_</button>
            <button onclick="switchSection('node')" class="nav-button" id="node-editor-btn" title="Editor">{&nbsp&nbsp}</button>
            <button onclick="switchSection('code')" class="nav-button active" id="code-editor-btn" title="Editor">f(x)</button>
        </nav>
        <section class="multi-editors activePage">
            <div id="main-editor" class="editor"></div>
        </section>
        <section id="terminal"></section>
        <section id="files"></section>
    </div>

    <script src="./js/main.js"></script>
    <script src="./js/ui.js"></script>
    <script src="./js/monaco.js"></script>
    <script src="./js/workflow.js"></script>
    <script src="./js/nodes.js"></script>
    <script src="./js/autoResize.js"></script>
    <script>
        const { invoke } = window.__TAURI__.core;
        const { listen } = window.__TAURI__.event;

        // 主初始化函数
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化自适应画布管理器
            const canvasManager = new AdaptiveCanvasManager('workflowCanvas');

            initializeDefaultNodes();
            
            // 创建LiteGraph实例
            setTimeout(() => {
                window.graph = new LGraph();
                window.canvas = new LGraphCanvas("#workflowCanvas", window.graph);
                // 启动图形
            }, 10);
        });

        class TerminalComponent {
            constructor(containerId) {
                this.terminal = new Terminal({
                    convertEol: true,
                    theme: {
                        background: '#282C33',
                        foreground: '#cccccc',
                        cursor: '#ffffff',
                        black: '#000000',
                        red: '#cd3131',
                        green: '#0dbc79',
                        yellow: '#e5e510',
                        blue: '#2472c8',
                        magenta: '#bc3fbc',
                        cyan: '#11a8cd',
                        white: '#e5e5e5'
                    }
                });
                
                const container = document.getElementById(containerId);
                this.terminal.open(container);
                
                this.isProcessRunning = false;
                this.setupEventListeners();
                this.setupKeyboardHandlers();
            }
            
            async setupEventListeners() {
                try {
                    const { listen } = window.__TAURI__.event;
                    
                    // 监听后端输出事件
                    this.unlistenOutput = await listen('command-output', (event) => {
                        const payload = event.payload;
                        this.terminal.write(payload.content);
                    });
                    
                    // 监听命令完成事件（如果需要）
                    this.unlistenCompleted = await listen('command-completed', () => {
                        this.terminal.write('\r\n命令执行完成\r\n');
                    });
                    
                } catch (error) {
                    console.error('设置事件监听器失败:', error);
                    this.terminal.write('终端初始化失败，请刷新页面\r\n');
                }
                
                // 终端输入处理
                this.terminal.onData(data => {
                    console.log(data)
                    // this.sendInput(data);
                });
            }
            
            setupKeyboardHandlers() {
                // 处理特殊按键
                this.terminal.attachCustomKeyEventHandler((event) => {
                    // 处理 Ctrl+C
                    if (event.ctrlKey && event.code === 'KeyC' && event.type === 'keydown') {
                        this.sendInput('\x03'); // Ctrl+C 的转义序列
                        return false;
                    }
                    // 处理 Ctrl+D
                    if (event.ctrlKey && event.code === 'KeyD' && event.type === 'keydown') {
                        this.sendInput('\x04'); // Ctrl+D 的转义序列
                        return false;
                    }
                    // 处理 Ctrl+Z
                    if (event.ctrlKey && event.code === 'KeyZ' && event.type === 'keydown') {
                        this.sendInput('\x1a'); // Ctrl+Z 的转义序列
                        return false;
                    }
                    return true;
                });
            }
            
            async executeCommand(cmd, args = []) {
                try {
                    // 清除终端
                    this.terminal.clear();
                    this.terminal.write(`$ ${cmd} ${args.join(' ')}\r\n`);
                    
                    // 执行命令
                    await invoke('execute_command_realtime', { 
                        cmd, 
                        args 
                    });

                    this.isProcessRunning = true;

                } catch (error) {
                    this.terminal.write(`\r\n错误: ${error}\r\n`);
                }
            }
            
            async sendInput(data) {
                // 检查进程是否在运行
                if (!this.isProcessRunning) {
                    // 如果没有运行中的进程，直接显示输入
                    this.terminal.write(data);
                    return;
                }

                try {
                    // 发送用户输入到子进程
                    await invoke('send_terminal_input', { input: data });
                } catch (error) {
                    if (error.includes('进程已结束') || error.includes('管道被关闭')) {
                        this.isProcessRunning = false;
                        this.terminal.write('\r\n进程已结束\r\n');
                    } else {
                        console.error('发送输入失败:', error);
                    }
                }
            }
            
            async killProcess() {
                try {
                    await invoke('kill_current_process');
                    this.isProcessRunning = false;
                    this.terminal.write('\r\n进程已终止\r\n');
                } catch (error) {
                    console.error('终止进程失败:', error);
                }
            }
            
            // 清理函数
            destroy() {
                if (this.unlistenOutput) {
                    this.unlistenOutput();
                }
                if (this.unlistenCompleted) {
                    this.unlistenCompleted();
                }
                this.terminal.dispose();
            }
        }

        // 全局变量以便其他脚本可以访问
        window.terminal = new TerminalComponent('terminal');
        
        // 测试函数 - 可以在控制台调用
        window.runCommand = function(cmd, args = []) {
            window.terminal.executeCommand(cmd, args);
        };
        
        // 终止当前进程的函数
        window.killProcess = function() {
            window.terminal.killProcess();
        };
        
        // 运行交互式 shell 的命令
        window.startShell = function() {
            const isWindows = navigator.platform.toLowerCase().includes('win');
            if (isWindows) {
                window.terminal.executeCommand('cmd', []);
            } else {
                window.terminal.executeCommand('bash', []);
            }
        };
        
        // 默认启动一个交互式 shell
        window.startShell();
    </script>
    <!-- 小土星悬浮菜单球 -->
    <link rel="stylesheet" href="./css/floatball.css">
    <div class="saturn-menu-container">
        <div class="saturn-ring-lower saturn-ring"></div>
        <div class="saturn-ring-upper saturn-ring"></div>
        <div class="saturn-ball">
            <div class="glow"></div>
            <nav class="saturn-icon" id="setting">
                <svg width="30" height="30" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 21h-4l-.551-2.48a7 7 0 0 1-1.819-1.05l-2.424.763-2-3.464 1.872-1.718a7 7 0 0 1 0-2.1L3.206 9.232l2-3.464 2.424.763A7 7 0 0 1 9.45 5.48L10 3h4l.551 2.48a7 7 0 0 1 1.819 1.05l2.424-.763 2 3.464-1.872 1.718a7 7 0 0 1 0 2.1l1.872 1.718-2 3.464-2.424-.763a7 7 0 0 1-1.819 1.052z"/><circle cx="12" cy="12" r="3" stroke-width="2"/></svg>
            </nav>
            <nav class="icon-item" id="import" tabindex="0" role="button">
                <svg width="30" height="30" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M14 9a1 1 0 0 1 1 1v3a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-3a1 1 0 0 1 2 0v3h10v-3a1 1 0 0 1 1-1M8 1a1 1 0 0 1 1 1v4.586l1.293-1.293a1 1 0 1 1 1.414 1.414L8 10.414 4.293 6.707a1 1 0 0 1 1.414-1.414L7 6.586V2a1 1 0 0 1 1-1"/></svg>
            </nav>
            <nav class="icon-item" id="outport" tabindex="0" role="button">
                <svg width="30" height="30" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M14 9.004a1 1 0 0 1 1 1v3a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-3a1 1 0 0 1 2 0v3h10v-3a1 1 0 0 1 1-1M8 1.59l3.707 3.707a1 1 0 0 1-1.414 1.414L9 5.418v4.586a1 1 0 1 1-2 0V5.418L5.707 6.711a1 1 0 0 1-1.414-1.414z"/></svg>
            </nav>
        </div>
    </div>
    <script src="./js/floatball.js"></script>
</body>

</html>