<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>X6 Workflow Editor</title>
    <link rel="stylesheet" href="https://unpkg.com/@antv/x6@2.x/dist/x6.css">
    <style>
        #container {
            width: 100%;
            height: 100vh;
            border: 1px solid #f0f0f0;
        }
        #stencil {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 200px;
            height: 400px;
            border: 1px solid #f0f0f0;
        }
    </style>
</head>
<body>
    <div id="container"></div>
    <div id="stencil"></div>

    <script src="./js/x6.js"></script>
    <script>
        // 初始化画布
        const graph = new X6.Graph({
            container: document.getElementById('container'),
            width: 800,
            height: 600,
            grid: true,
            snapline: true,
            panning: true,
            connecting: {
                snap: true,
                allowBlank: false,
                allowLoop: false,
                allowEdge: false,
                allowNode: false,
                connector: 'rounded',
                connectionPoint: 'boundary',
                validateMagnet: ({ magnet }) => {
                    return magnet.getAttribute('port-group') !== 'in'
                },
                validateConnection: ({ sourceView, targetView, sourceMagnet, targetMagnet }) => {
                    // 不能连接到自己
                    if (sourceView === targetView) {
                        return false
                    }
                    
                    // 只能从输出端口连接到输入端口
                    const sourceGroup = sourceMagnet?.getAttribute('port-group')
                    const targetGroup = targetMagnet?.getAttribute('port-group')
                    return sourceGroup === 'out' && targetGroup === 'in'
                }
            }
        })

        // 注册自定义节点
        X6.Graph.registerNode('workflow-node', {
            inherit: 'rect',
            width: 180,
            height: 80,
            attrs: {
                body: {
                    stroke: '#5F95FF',
                    strokeWidth: 1,
                    fill: '#EFF4FF',
                    rx: 4,
                    ry: 4,
                },
                text: {
                    fontSize: 14,
                    color: '#262626',
                },
            },
            ports: {
                groups: {
                    in: {
                        position: 'left',
                        attrs: {
                            circle: {
                                r: 4,
                                magnet: true,
                                stroke: '#5F95FF',
                                strokeWidth: 1,
                                fill: '#fff',
                            },
                        },
                    },
                    out: {
                        position: 'right',
                        attrs: {
                            circle: {
                                r: 4,
                                magnet: true,
                                stroke: '#5F95FF',
                                strokeWidth: 1,
                                fill: '#fff',
                            },
                        },
                    },
                },
                items: [
                    {
                        id: 'in1',
                        group: 'in',
                    },
                    {
                        id: 'out1',
                        group: 'out',
                    },
                ],
            },
        })

        // 创建侧边栏拖拽
        const stencil = new X6.Addon.Stencil({
            title: '节点库',
            target: graph,
            stencilGraphWidth: 200,
            stencilGraphHeight: 400,
            layoutOptions: {
                columns: 1,
                columnWidth: 180,
                rowHeight: 80,
            },
        })

        document.getElementById('stencil').appendChild(stencil.container)

        // 创建示例节点
        const node = graph.createNode({
            shape: 'workflow-node',
            label: '工作节点',
        })

        stencil.load([node], 'group1')

        // 添加节点删除功能
        graph.on('node:contextmenu', ({ node, e }) => {
            e.preventDefault()
            graph.removeNode(node.id)
        })

        // 添加边删除功能
        graph.on('edge:contextmenu', ({ edge, e }) => {
            e.preventDefault()
            graph.removeEdge(edge.id)
        })

        // 示例：添加节点按钮
        const addNodeBtn = document.createElement('button')
        addNodeBtn.textContent = '添加节点'
        addNodeBtn.style.position = 'absolute'
        addNodeBtn.style.top = '10px'
        addNodeBtn.style.right = '10px'
        addNodeBtn.onclick = () => {
            const newNode = graph.createNode({
                shape: 'workflow-node',
                x: Math.random() * 500,
                y: Math.random() * 400,
                label: '新节点',
            })
            graph.addNode(newNode)
        }
        document.body.appendChild(addNodeBtn)
    </script>
</body>
</html>