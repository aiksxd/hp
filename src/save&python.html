<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tauri æ–‡ä»¶å¦å­˜ä¸ºæ¼”ç¤º</title>
    <style>
        body { font-family: sans-serif; padding: 2rem; background-color: #f5f5f5; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        button { background-color: #007acc; color: white; border: none; padding: 10px 20px; margin: 10px 5px; border-radius: 5px; cursor: pointer; font-size: 16px; }
        button:hover { background-color: #005a9e; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        #result { margin-top: 20px; padding: 15px; background-color: #e9e9e9; border-radius: 5px; white-space: pre-wrap; word-break: break-all; min-height: 100px; }
        .status { margin-top: 10px; font-style: italic; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <h2>æ–‡ä»¶å¦å­˜ä¸ºæ¼”ç¤º</h2>
        <p>1. é€‰æ‹©ä¸€ä¸ªæºæ–‡ä»¶ (å¦‚ .txt, .png)ã€‚<br>2. é€‰æ‹©ä¸€ä¸ªç›®æ ‡ä½ç½®ä¿å­˜å‰¯æœ¬ã€‚</p>
        
        <button id="saveAsBtn">å¦å­˜æ–‡ä»¶ä¸º...</button>
        
        <div>
            <strong>æ“ä½œçŠ¶æ€ï¼š</strong>
            <div id="result">ç­‰å¾…æ“ä½œ...</div>
            <div id="status" class="status"></div>
        </div>
    </div>

    <script type="module">
        // å¯¼å…¥æ‰€éœ€çš„ API
        const { open, save } = window.__TAURI__.dialog;
        const { readFile, writeFile } = window.__TAURI__.fs;
        const { callFunction } = window.__TAURI__.python;
        console.log(await callFunction('greet_python', [parseInt(1), parseInt(2)]))
        // è·å–DOMå…ƒç´ 
        const saveAsBtn = document.getElementById('saveAsBtn');
        const resultDiv = document.getElementById('result');
        const statusDiv = document.getElementById('status');

        // ä¸ºâ€œå¦å­˜ä¸ºâ€æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
        saveAsBtn.addEventListener('click', async () => {
            // é‡ç½®çŠ¶æ€
            saveAsBtn.disabled = true;
            statusDiv.textContent = 'æ­£åœ¨æ‰“å¼€æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†...';
            resultDiv.textContent = '';

            try {
                // --- ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©æºæ–‡ä»¶ ---
                const sourcePath = await open({
                    multiple: false,
                    directory: false,
                    title: 'è¯·é€‰æ‹©è¦å¦å­˜çš„æ–‡ä»¶',
                    filters: [{
                        name: 'æ‰€æœ‰æ–‡ä»¶',
                        extensions: ['*'] // å…è®¸é€‰æ‹©ä»»ä½•æ–‡ä»¶
                    }, {
                        name: 'æ–‡æœ¬æ–‡ä»¶',
                        extensions: ['txt', 'md', 'json', 'html', 'js']
                    }, {
                        name: 'å›¾ç‰‡æ–‡ä»¶',
                        extensions: ['png', 'jpg', 'jpeg', 'gif']
                    }]
                });

                if (!sourcePath) {
                    statusDiv.textContent = 'ç”¨æˆ·å–æ¶ˆäº†æºæ–‡ä»¶é€‰æ‹©ã€‚';
                    saveAsBtn.disabled = false;
                    return;
                }
                // å¦‚æœç”¨æˆ·é€‰æ‹©çš„æ˜¯å•ä¸ªæ–‡ä»¶ï¼Œopen API ä¼šè¿”å›å­—ç¬¦ä¸²ï¼Œå¦‚æœæ˜¯å¤šä¸ªåˆ™è¿”å›æ•°ç»„ã€‚
                // å› ä¸ºæˆ‘ä»¬è®¾ç½®äº† multiple: falseï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥ä½¿ç”¨ã€‚
                const sourceFilePath = sourcePath;
                resultDiv.textContent = `âœ… å·²é€‰æ‹©æºæ–‡ä»¶ï¼š\n${sourceFilePath}`;
                statusDiv.textContent = 'æ­£åœ¨è¯»å–æ–‡ä»¶å†…å®¹...';

                // --- ç¬¬äºŒæ­¥ï¼šè¯»å–æºæ–‡ä»¶å†…å®¹ï¼ˆä»¥äºŒè¿›åˆ¶æ ¼å¼ï¼Œé€‚ç”¨äºæ‰€æœ‰æ–‡ä»¶ç±»å‹ï¼‰---
                const fileContent = await readFile(sourceFilePath);
                statusDiv.textContent = `æ–‡ä»¶è¯»å–æˆåŠŸ (${fileContent.length} å­—èŠ‚)ã€‚æ­£åœ¨æ‰“å¼€ä¿å­˜å¯¹è¯æ¡†...`;

                // --- ç¬¬ä¸‰æ­¥ï¼šé€‰æ‹©ç›®æ ‡ä¿å­˜è·¯å¾„ ---
                // å¯ä»¥ä»æºæ–‡ä»¶åä¸­æå–ä¸€ä¸ªé»˜è®¤çš„ä¿å­˜å
                const sourceFileName = sourceFilePath.split(/[\\/]/).pop(); // è·å–æ–‡ä»¶åéƒ¨åˆ†
                const targetPath = await save({
                    title: 'è¯·é€‰æ‹©ä¿å­˜å‰¯æœ¬çš„ä½ç½®',
                    filters: [{
                        name: 'ä¸åŸæ–‡ä»¶ç›¸åŒ',
                        extensions: [sourceFileName.split('.').pop() || '*'] // å°è¯•ä¿æŒç›¸åŒæ‰©å±•å
                    }],
                    defaultPath: `å‰¯æœ¬_${sourceFileName}` // å»ºè®®ä¸€ä¸ªé»˜è®¤æ–‡ä»¶å
                });

                if (!targetPath) {
                    statusDiv.textContent = 'ç”¨æˆ·å–æ¶ˆäº†ä¿å­˜ä½ç½®é€‰æ‹©ã€‚';
                    saveAsBtn.disabled = false;
                    return;
                }

                resultDiv.textContent += `\n\nğŸ¯ ç›®æ ‡ä¿å­˜è·¯å¾„ï¼š\n${targetPath}`;
                statusDiv.textContent = 'æ­£åœ¨å†™å…¥æ–‡ä»¶...';

                // --- ç¬¬å››æ­¥ï¼šå°†å†…å®¹å†™å…¥æ–°ä½ç½® ---
                await writeFile(targetPath, fileContent);
                statusDiv.textContent = `âœ… æ–‡ä»¶å·²æˆåŠŸä¿å­˜è‡³æ–°ä½ç½®ï¼`;
                resultDiv.textContent += `\n\nâœ¨ æ“ä½œå®Œæˆï¼æ–‡ä»¶å‰¯æœ¬å·²åˆ›å»ºã€‚`;

            } catch (error) {
                console.error(error);
                statusDiv.textContent = `âŒ æ“ä½œå‡ºé”™ï¼`;
                resultDiv.textContent = `é”™è¯¯ä¿¡æ¯ï¼š\n${error}`;
            } finally {
                saveAsBtn.disabled = false;
            }
        });
    </script>
</body>
</html>